<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <title>
      (Ab)using range-based for &bull; Lounge&lt;C++&gt;
    </title>
    <link href="../../assets/css/all-89eed68e.css" rel="stylesheet" type="text/css" />
    <script src="../../assets/js/all-da39a3ee.js" type="text/javascript"></script>
    <link href="../../favicon.png" rel="icon" type="image/png" />
  </head>
  <body class='cpp cpp_abusing-range-for cpp_abusing-range-for_index'>
    <div class='page-container'>
      <header class='page-header'>
        <img alt='Lounge&lt;C++&gt;' class='page-header-logo' src='/assets/img/logo-89fbe1a2.png'>
        <h1 class='page-header-title'>
          <a href='/'>Lounge&lt;C++&gt;</a>
        </h1>
      </header>
      <p>Range-based for loops are syntactic sugar over a traditional loop with iterators.
      They make the previous idiom simpler and also enable some new ones.</p>
      
      <h2>Loop through integers, Python-style</h2>
      
      <p>No one would dare use <code>boost::irange</code> in a traditional loop. But with the new loop, it&#39;s not that unwieldy:</p>
      
      <pre><code>for(int i : boost::irange(0, 10)) {
          std::cout &lt;&lt; i &lt;&lt; &#39;\n&#39;;
      }
      // prints: 0 1 2 3 4 5 6 7 8 9 
      </code></pre>
      
      <p>... or in reverse:</p>
      
      <pre><code>for(int i : boost::irange(0, 10) | boost::adaptors::reversed) {
          std::cout &lt;&lt; i &lt;&lt; &#39; &#39;;
      }
      // prints: 9 8 7 6 5 4 3 2 1 0 
      </code></pre>
      
      <h2>To loop or not to loop</h2>
      
      <p><code>boost::optional</code> can be seen as a container that holds at most one element.
      So, why not loop over it? Just provide appropriate iterators and <code>begin</code> and <code>end</code> functions.</p>
      
      <pre><code>boost::optional&lt;T&gt; o = 42;
      for(auto&amp;&amp; t : o) {
         frob(t);
         schizzle(t);
      }
      </code></pre>
      
      <p>The code in the loop would run only when the optional holds a value (and only once), and <code>t</code> is automatically bound to it.</p>
      
      <h2>RAII</h2>
      
      <p>One interesting property of the range-based loop is that, if the range is a temporary,
      its lifetime is the whole loop (all iterations). This allows us to throw RAII semantics into mix.
      And what interesting things can we do with this? <a href="http://ideone.com/HK4Kw">Naturally enforced and properly scoped locks</a>!</p>
      
      <p>The idea is to, instead of keeping a mutex and the shared data it protects both visible and separate,
      we hide the data away and only reveal it when the mutex is acquired. We write a class with the mutex
      and data as private members and add an <code>open</code> function that acquires the mutex and returns an object that releases it upon destruction.</p>
      
      <p>Add the appropriate iterators to that, and we can write the following:</p>
      
      <pre><code>locker_box&lt;racy&gt; box; // shared data is not accessible without locking
      try {
          for(auto&amp;&amp; x : box.open()) {  // lock is acquired, and is held only while the loop runs
                                        // and the shared data becomes available through x
              x.do_racy_stuff();
              x.do_more_racy_stuff();
              x.do_really_raunchy_stuff();
          }
      } catch(not_suitable_for_this_audience const&amp;) {}
      </code></pre>
      <footer class='page-footer'>
        <p>
          Content on Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported unless noted otherwise.
          Uses Google Analytics which sets a tracking cookie for statistical purposes (see <a href="https://www.google.com/analytics/learn/privacy.html">GA privacy policy</a>).
        </p>
        <p>
          Source lives in a <a href="https://github.com/LoungeCPP/loungecpp.net">GitHub repository</a> and is powered
          by <a href="http://middlemanapp.com/">Middleman</a>. Open a PR if you want to change anything.
        </p>
      </footer>
    </div>
    <script defer src='//www.google-analytics.com/analytics.js'></script>
    <script src="../../assets/js/analytics-0a593893.js" type="text/javascript" defer="defer"></script>
  </body>
</html>
